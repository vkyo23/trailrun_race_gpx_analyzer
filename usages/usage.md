## 概要

このアプリケーションは、トレイルランニングの大会やトレーニングで使用するGPXファイルを分析し、
コース上の任意のポイント間の距離と累積標高を計算するツールです。

## 主な機能

- GPXファイルのアップロード（ローカルファイルまたはURL）
- GPXウェイポイントの自動読み込み（スタート/ゴール/エイドステーション等）
- インタラクティブな地図表示
- トラック進行方向の矢印表示
- 標高プロファイルグラフ
- マーカー設定（トラックライン上をクリックまたは緯度経度入力）
- マーカーの並び替え機能
- マーカー間のセグメント分析（距離、獲得標高、下降標高、平均斜度）
- セグメントデータのCSVエクスポート
- Strava/Garmin準拠の累積標高計算

## 使い方

### 1. GPXファイルのアップロード

#### ローカルファイルから
1. 「GPX分析」タブを開く
2. 「ローカルファイル」を選択
3. GPXファイルを選択してアップロード

#### URLから
1. 「GPX分析」タブを開く
2. 「URL」を選択
3. GPXファイルのURLを入力
4. 「URLから読み込み」ボタンをクリック

#### 自動マーカー登録
GPXファイルを読み込むと、以下のマーカーが自動的に登録されます：
- トラックの開始点（スタート）
- GPXファイルに含まれるウェイポイント（エイドステーション、チェックポイント等）
- トラックの終了点（ゴール）

これらの自動登録されたマーカーも、手動で追加したマーカーと同様に編集・削除・並び替えが可能です。

### 2. トラック統計の確認

GPXファイルを読み込むと、以下の統計情報が自動表示されます：
- 総距離（km）
- 獲得標高（m）
- 下降標高（m）
- 標高範囲（最低〜最高）
- トラックポイント数

### 3. マーカーの設定

#### トラッククリックで設定
1. 「マーカー名」を入力
2. 「トラッククリック」を選択
3. 地図上のトラックライン（オレンジ色のライン）をクリック
4. 「マーカーを追加」ボタンをクリック

**ポイント：**
- マーカー名は前回入力した内容が保持されるため、連続して同じ名前のマーカーを追加しやすくなっています
- クリックした位置から最も近いGPXトラック上のポイントに自動的に配置されます
- 追加したマーカーはゴールの一つ前に挿入されます

#### 緯度経度で設定
1. 「マーカー名」を入力
2. 「緯度経度入力」を選択
3. 緯度と経度を数値で入力
4. 「マーカーを追加」ボタンをクリック

#### マーカーの管理
- **↑↓ボタン**：マーカーの順序を変更（上下に移動）
- **削除ボタン**：個別にマーカーを削除
- **すべてのマーカーをクリア**：すべてのマーカーを一括削除

#### マーカー情報
各マーカーには以下の情報が表示されます：
- マーカー名
- 緯度・経度
- トラック上の距離
- 方角（GPXに方向データが含まれる場合）

### 4. セグメント分析

2つ以上のマーカーを設定すると、マーカー間のセグメント分析が表示されます：

- セグメント番号
- 開始・終了マーカー名
- 距離（km）
- 獲得標高（m）
- 下降標高（m）
- 平均斜度（%）：獲得標高÷距離×100で計算

#### セグメントのハイライト表示
1. セグメント分析表の下にあるドロップダウンでセグメントを選択
2. 選択したセグメントが地図（赤い太線）とグラフで即座にハイライト表示されます

#### CSVエクスポート
「CSVでダウンロード」ボタンをクリックすると、セグメント分析データをCSVファイルとして保存できます。

### 5. 地図とグラフの見方

#### 地図表示
- **オレンジ色の太線**：GPXトラック（クリック可能）
- **青い矢印**：トラックの進行方向（2km間隔、方角情報付き）
- **赤いピン**：最初のマーカー（スタート）
- **緑のピン**：最後のマーカー（ゴール）
- **青いピン**：中間のマーカー
- **赤い太線**：ハイライトされたセグメント
- **オレンジのピン**：選択中の座標（マーカー追加前）

**操作方法：**
- トラックライン上をクリックしてマーカー位置を指定
- マーカーをクリックすると詳細情報（距離、標高、方角）を表示
- 矢印にマウスオーバーすると進行方向の詳細を表示

#### 標高プロファイル
- 横軸：距離（km）
- 縦軸：標高（m）
- マウスオーバーで詳細情報表示
- マーカー位置が赤点で表示
- ハイライトされたセグメントが強調表示

## 使用例

### 大会の準備

1. 大会公式サイトからGPXファイルをダウンロードまたはURL取得
2. アプリにアップロード
3. エイドステーション、チェックポイント、重要な地点にマーカーを設定
4. エイド間の距離と累積標高を確認
5. セグメントデータをCSVでエクスポート
6. ペース配分とクルー計画を立案

### トレーニング計画

1. 練習コースのGPXファイルをアップロード
2. 区間を分割するためのマーカーを設定
3. 各区間の距離と標高を確認
4. インターバルトレーニングやテンポ走の計画に活用

### コース偵察

1. 事前走や試走で記録したGPXファイルをアップロード
2. 難所や重要ポイントにマーカーを設定
3. 各区間の特性を把握
4. 本番の戦略を検討

## 技術的な詳細

### 累積標高の計算方法

本アプリケーションは、Strava、Garmin、Corosなどの主要プラットフォームと同様の計算方式を採用：

1. **スムージング処理**
   - GPSの測位誤差によるノイズを除去するため、移動平均フィルタを適用
   - デフォルトのウィンドウサイズ：5ポイント

2. **閾値処理**
   - 3m以上の標高変化のみをカウント（設定で変更可能）
   - 微小な変動を無視することで、より正確な累積標高を算出

3. **方向別の累積**
   - 上昇と下降を分けて計算
   - 単純な標高差の合計ではなく、実際の累積値を算出

### 距離計算

- **Haversine公式**を使用した測地距離計算
- 地球を球体と仮定し、2点間の大圏距離を算出
- トラック上の各ポイント間の距離を累積

### マーカー配置

- 入力された座標に対して、GPXトラック上の最も近いポイントを検索
- 実際のトラック上のポイントにマーカーを配置
- トラック上の距離を正確に計算

## データのプライバシー

- アップロードされたGPXファイルはセッション中のみメモリに保存
- サーバーに永続的に保存されることはありません
- ページを閉じるとすべてのデータがクリアされます

## ファイル制限

- 最大ファイルサイズ：50MB
- 対応形式：GPX (GPS Exchange Format)

## トラブルシューティング

### GPXファイルが読み込めない
- ファイル形式がGPXであることを確認
- ファイルサイズが50MB以下であることを確認
- トラックデータが含まれていることを確認

### 標高が他のサービスと異なる
- GPSデータの精度やスムージングアルゴリズムの違いにより、若干の差が生じることがあります
- 本アプリは一般的なスポーツトラッキングサービスと同様の方式を採用しています

### マーカーが追加できない
- マーカー名が入力されているか確認
- 座標が指定されているか確認（トラックラインをクリックまたは緯度経度入力）
- トラックライン上をクリックしていることを確認（トラック外をクリックしても反応しません）

### 方向矢印が表示されない
- GPXファイルに方向（course）データが含まれていない場合、自動的に前後のポイントから計算されます
- 矢印は2km間隔で表示されます
- トラックが短い場合（2km未満）は矢印が表示されないことがあります

## その他

詳細な技術仕様やソースコードは、GitHubリポジトリを参照してください。
